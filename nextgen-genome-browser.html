<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Next-Gen Genome Browser</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #0b1220;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22c55e;
      --border: #1e293b;
      --danger: #ef4444;
      --shadow: 0 10px 30px #00000025;
      --track-spacing: 18px;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color-scheme: dark;
    }
    [data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-2: #f1f5f9;
      --fg: #0f172a;
      --muted: #475569;
      --accent: #0ea5e9;
      --border: #e2e8f0;
      --danger: #dc2626;
      --shadow: 0 10px 30px #0f172a22;
      color-scheme: light;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--fg); display: flex; flex-direction: column; min-height: 100vh; }
    header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 12px 16px; display: grid; grid-template-columns: 1fr 2fr; gap: 12px; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.2px; }
    .subtitle { color: var(--muted); font-size: 12px; margin-top: 2px; }
    .top-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; align-items: end; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    input, select, button, textarea { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel-2); color: var(--fg); font-size: 13px; }
    button { cursor: pointer; transition: all 0.2s ease; }
    button.primary { background: linear-gradient(120deg, var(--accent), #4ade80); color: #0f172a; font-weight: 700; border: none; }
    button.secondary { background: var(--panel-2); color: var(--fg); }
    button:hover { box-shadow: 0 0 0 2px #22c55e33; border-color: var(--accent); }
    main { flex: 1; display: grid; grid-template-columns: 320px minmax(0, 1fr); min-height: 0; }
    aside { background: var(--panel); border-right: 1px solid var(--border); padding: 16px; display: grid; gap: 14px; overflow-y: auto; }
    .panel { background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); }
    .panel h2 { margin: 0 0 8px; font-size: 15px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .panel small { color: var(--muted); }
    .track-row { border: 1px solid var(--border); border-radius: 10px; padding: 8px; display: grid; grid-template-columns: 1fr; gap: 6px; background: var(--bg); }
    .track-row header { display: flex; justify-content: space-between; align-items: center; padding: 0; border: none; background: transparent; }
    .chip { padding: 3px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--panel); font-size: 12px; color: var(--muted); }
    .swatch { width: 12px; height: 12px; border-radius: 4px; border: 1px solid var(--border); }
    .track-controls { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px; }
    .stack { display: flex; align-items: center; gap: 6px; }
    .browser { padding: 16px; display: grid; gap: 10px; min-height: 0; }
    .svg-shell { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; box-shadow: inset 0 1px 0 #ffffff05; min-height: 420px; display: flex; flex-direction: column; gap: 8px; }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; }
    .status-bar { padding: 10px 14px; border-top: 1px solid var(--border); background: var(--panel); color: var(--muted); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 6px; font-size: 13px; }
    .muted { color: var(--muted); }
    textarea { min-height: 80px; resize: vertical; }
    .error { color: var(--danger); font-size: 12px; min-height: 14px; }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
      aside { order: 2; border-right: none; border-top: 1px solid var(--border); }
      header { grid-template-columns: 1fr; position: static; }
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div>
      <h1>Next-Gen Genome Browser</h1>
      <div class="subtitle">D3.js-first overlay for UCSC Genome Browser · Pan, zoom, and custom tracks</div>
      <div class="stack" style="flex-wrap: wrap; margin-top: 6px;">
        <span class="chip">Standalone HTML</span>
        <span class="chip">D3 v7</span>
        <button id="openUCSC" class="secondary" style="width:auto; padding:6px 10px;">Open in UCSC</button>
      </div>
    </div>
    <div class="top-controls">
      <div>
        <label for="assembly">Assembly</label>
        <select id="assembly">
          <option value="hg38">hg38</option>
          <option value="hg19">hg19 (demo)</option>
        </select>
      </div>
      <div>
        <label for="search">Gene or region</label>
        <input id="search" placeholder="BRCA1 or chr17:43000000-43100000" />
      </div>
      <div style="display:flex; gap:6px; align-items:flex-end;">
        <button id="go" class="primary" style="width:auto;">Go</button>
        <button id="zoomIn" class="secondary" style="width:auto;">Zoom ×2</button>
        <button id="zoomOut" class="secondary" style="width:auto;">Zoom ÷2</button>
      </div>
    </div>
  </header>
  <main>
    <aside>
      <div class="panel">
        <h2>Tracks</h2>
        <small>Reorder, hide, or adjust tracks. Changes persist locally.</small>
        <div id="trackList" style="display:grid; gap:8px; margin-top:8px;"></div>
      </div>
      <div class="panel">
        <h2>Add custom track</h2>
        <small>Paste tab-delimited rows: chrom start end name [value|strand]</small>
        <div class="stack">
          <input type="file" id="fileInput" accept=".bed,.txt,.tsv" style="flex:1;" />
        </div>
        <textarea id="customText" placeholder="chr17\t43050000\t43052000\tfeature1\t+"></textarea>
        <div class="track-controls" style="grid-template-columns: repeat(2, minmax(0,1fr));">
          <div>
            <label>Name</label>
            <input id="customName" placeholder="My custom track" />
          </div>
          <div>
            <label>Color</label>
            <input id="customColor" type="color" value="#f97316" />
          </div>
          <div>
            <label>Type</label>
            <select id="customType">
              <option value="variants">Variants</option>
              <option value="genes">Regions/genes</option>
              <option value="coverage">Coverage</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button id="addTrack" class="primary">Add track</button>
          </div>
        </div>
        <div id="customError" class="error"></div>
      </div>
      <div class="panel">
        <h2>Global settings</h2>
        <div class="track-controls" style="grid-template-columns: 1fr;">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="themeToggle" /> Light theme
          </label>
          <div>
            <label>Track spacing (<span id="spacingValue">18</span> px)</label>
            <input type="range" id="spacing" min="4" max="40" value="18" />
          </div>
          <button id="reset" class="secondary">Reset to defaults</button>
        </div>
      </div>
    </aside>
    <section class="browser">
      <div id="status" class="panel" style="border-style:dashed;">Ready.</div>
      <div class="svg-shell">
        <div class="legend" id="legend"></div>
        <svg id="browserSvg" width="100%" height="520"></svg>
        <div class="muted" style="font-size:12px;">Drag to pan, scroll to zoom. Click features for details.</div>
      </div>
    </section>
  </main>
  <div class="status-bar" id="statusBar">
    <div>Assembly: <strong id="statusAssembly">hg38</strong></div>
    <div>Region: <strong id="statusRegion">chr17:43000000-43100000</strong></div>
    <div>Scale: <strong id="statusScale">?</strong></div>
    <div id="hint" class="muted">Hover for details. Tracks persist in localStorage.</div>
  </div>

  <script>
  (function() {
    /** @typedef {Object} Track */
    const assemblies = {
      hg38: {
        name: 'GRCh38/hg38',
        chromosomes: {
          chr1: { length: 248956422 },
          chr17: { length: 83257441 },
          chr7: { length: 159345973 }
        }
      },
      hg19: {
        name: 'GRCh37/hg19 (demo)',
        chromosomes: {
          chr1: { length: 249250621 },
          chr17: { length: 81195210 }
        }
      }
    };

    const geneAliases = {
      BRCA1: { assembly: 'hg38', chrom: 'chr17', start: 43044293, end: 43170245 },
      TP53: { assembly: 'hg38', chrom: 'chr17', start: 7661779, end: 7687550 },
      EGFR: { assembly: 'hg38', chrom: 'chr7', start: 55086714, end: 55270768 }
    };

    const storageKey = 'nextgenGenomeBrowser_v1';

    const defaultState = () => ({
      assembly: 'hg38',
      chrom: 'chr17',
      start: 43000000,
      end: 43100000,
      theme: 'dark',
      spacing: 18,
      tracks: [
        {
          id: 'builtin-genes',
          name: 'RefGene (demo)',
          type: 'genes',
          color: '#60a5fa',
          height: 60,
          opacity: 1,
          visible: true,
          source: 'builtin',
          data: sampleGenes()
        },
        {
          id: 'builtin-variants',
          name: 'Variants (demo)',
          type: 'variants',
          color: '#f43f5e',
          height: 50,
          opacity: 1,
          visible: true,
          source: 'builtin',
          data: sampleVariants()
        },
        {
          id: 'builtin-coverage',
          name: 'Coverage (demo)',
          type: 'coverage',
          color: '#22c55e',
          height: 60,
          opacity: 0.9,
          visible: true,
          source: 'builtin',
          data: sampleCoverage()
        },
        {
          id: 'builtin-sequence',
          name: 'Base sequence',
          type: 'sequence',
          color: '#f59e0b',
          height: 30,
          opacity: 1,
          visible: true,
          source: 'builtin',
          data: ''
        }
      ]
    });

    let state = loadState();

    const svg = d3.select('#browserSvg');
    const statusEl = document.getElementById('status');
    const statusBarRegion = document.getElementById('statusRegion');
    const statusBarAssembly = document.getElementById('statusAssembly');
    const statusScale = document.getElementById('statusScale');
    const spacingSlider = document.getElementById('spacing');
    const spacingValue = document.getElementById('spacingValue');

    function sampleGenes() {
      return [
        { name: 'BRCA1', start: 43045629, end: 43125482, strand: '+', exons: [{start:43045629,end:43047703},{start:43124000,end:43125482}] },
        { name: 'NBR1', start: 42972800, end: 43044292, strand: '-', exons: [{start:42972800,end:42973900},{start:43042000,end:43044292}] }
      ];
    }

    function sampleVariants() {
      return [
        { id: 'rs1', pos: 43050000, value: 0.4 },
        { id: 'rs2', pos: 43080000, value: 0.8 },
        { id: 'rs3', pos: 43095000, value: 0.6 }
      ];
    }

    function sampleCoverage() {
      const arr = [];
      let pos = 43000000;
      for (let i = 0; i < 100; i++) {
        arr.push({ start: pos, end: pos + 1000, value: 10 + 20 * Math.abs(Math.sin(i/8)) });
        pos += 1000;
      }
      return arr;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return defaultState();
        parsed.tracks = parsed.tracks || defaultState().tracks;
        return parsed;
      } catch (e) {
        console.warn('Failed to load state', e);
        return defaultState();
      }
    }

    const saveState = debounce(() => {
      try {
        localStorage.setItem(storageKey, JSON.stringify(state));
      } catch (e) {
        console.warn('Unable to persist state', e);
      }
    }, 300);

    function debounce(fn, wait = 150) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }

    function clampRegion() {
      const chromLen = assemblies[state.assembly]?.chromosomes?.[state.chrom]?.length || 1e9;
      const minSpan = 50;
      const maxSpan = Math.min(chromLen, 5e7);
      let start = Math.max(1, Math.floor(state.start));
      let end = Math.max(start + minSpan, Math.floor(state.end));
      if (end - start > maxSpan) end = start + maxSpan;
      if (end > chromLen) { end = chromLen; start = Math.max(1, end - maxSpan); }
      state.start = start;
      state.end = end;
    }

    function bpPerPixel() {
      const w = innerWidthForSvg();
      return (state.end - state.start) / w;
    }

    function innerWidthForSvg() {
      const node = svg.node();
      const rect = node?.getBoundingClientRect();
      return Math.max(400, (rect?.width || 800) - 60);
    }

    function scaleX() {
      return d3.scaleLinear().domain([state.start, state.end]).range([40, innerWidthForSvg()+40]);
    }

    async function fetchSequence() {
      const span = state.end - state.start;
      if (span > 20000) return { sequence: '', source: 'window too large' };
      const url = `https://api.genome.ucsc.edu/getData/sequence?genome=${encodeURIComponent(state.assembly)};chrom=${encodeURIComponent(state.chrom)};start=${Math.floor(state.start)};end=${Math.floor(state.end)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const seq = json?.dna || json?.sequence || json?.seq || '';
        if (!seq) throw new Error('Empty sequence');
        return { sequence: seq, source: 'UCSC REST' };
      } catch (err) {
        console.warn('Sequence fetch failed', err);
        const len = Math.min(20000, span);
        const bases = ['A','C','G','T'];
        let seq = '';
        for (let i = 0; i < len; i++) seq += bases[(state.start + i) % 4];
        return { sequence: seq, source: 'synthetic demo' };
      }
    }

    function updateStatus(msg, ok = true) {
      statusEl.textContent = msg;
      statusEl.style.borderColor = ok ? 'var(--border)' : 'var(--danger)';
      statusEl.style.color = ok ? 'inherit' : 'var(--danger)';
    }

    function renderLegend() {
      const legend = d3.select('#legend');
      const visible = state.tracks.filter(t => t.visible !== false);
      const items = legend.selectAll('.legend-item').data(visible, d => d.id);
      const enter = items.enter().append('div').attr('class','legend-item');
      enter.append('div').attr('class','swatch');
      enter.append('span');
      const merged = enter.merge(items);
      merged.select('.swatch').style('background', d => d.color || '#a3e635');
      merged.select('span').text(d => d.name);
      items.exit().remove();
    }

    function renderTrackList() {
      const container = d3.select('#trackList');
      const rows = container.selectAll('.track-row').data(state.tracks, d => d.id);
      const enter = rows.enter().append('div').attr('class','track-row');
      const header = enter.append('header');
      const info = header.append('div').attr('class','stack');
      info.append('div').attr('class','swatch');
      info.append('div').append('strong');
      info.append('div').attr('class','chip');
      const actions = header.append('div').attr('class','stack');
      actions.append('button').attr('class','secondary').attr('data-dir','up').text('↑');
      actions.append('button').attr('class','secondary').attr('data-dir','down').text('↓');
      actions.append('input').attr('type','checkbox');
      const controls = enter.append('div').attr('class','track-controls');
      controls.append('div').html('<label>Height</label><input type="range" min="20" max="160" />');
      controls.append('div').html('<label>Opacity</label><input type="range" min="0.2" max="1" step="0.05" />');
      const merged = enter.merge(rows);
      merged.select('.swatch').style('background', d => d.color || '#a3e635');
      merged.select('strong').text(d => d.name);
      merged.select('.chip').text(d => d.type);
      merged.select('input[type="checkbox"]').property('checked', d => d.visible !== false)
        .on('change', (ev, d) => { d.visible = ev.target.checked; saveState(); renderAll(); });
      merged.selectAll('button[data-dir]').on('click', (event, d) => {
        const dir = event.currentTarget?.getAttribute('data-dir');
        reorderTrack(d.id, dir === 'up' ? -1 : 1);
      });
      merged.selectAll('input[type="range"]').each(function(d) {
        const input = d3.select(this);
        if (input.attr('max') === '160') {
          input.property('value', d.height || 60).on('input', (ev) => { d.height = Number(ev.target.value); saveState(); renderAll(); });
        } else {
          input.property('value', d.opacity || 1).on('input', (ev) => { d.opacity = Number(ev.target.value); saveState(); renderAll(); });
        }
      });
      rows.exit().remove();
    }

    function reorderTrack(id, delta) {
      const idx = state.tracks.findIndex(t => t.id === id);
      if (idx < 0) return;
      const newIdx = Math.max(0, Math.min(state.tracks.length - 1, idx + delta));
      if (newIdx === idx) return;
      const [item] = state.tracks.splice(idx, 1);
      state.tracks.splice(newIdx, 0, item);
      saveState();
      renderTrackList();
      renderTracks();
    }

    function parseRegionInput(str) {
      if (!str) return null;
      const trimmed = str.trim();
      if (geneAliases[trimmed]) return { ...geneAliases[trimmed] };
      const match = trimmed.match(/^(chr\w+):(\d+)-(\d+)$/i);
      if (match) {
        return { chrom: match[1], start: Number(match[2]), end: Number(match[3]) };
      }
      return null;
    }

    function updateStatusBar() {
      statusBarRegion.textContent = `${state.chrom}:${state.start.toLocaleString()}-${state.end.toLocaleString()}`;
      statusBarAssembly.textContent = state.assembly;
      const scale = bpPerPixel();
      let label = `${scale.toFixed(2)} bp / px`;
      if (scale > 1000) label = `${(scale/1000).toFixed(2)} kb / px`;
      statusScale.textContent = label;
    }

    function drawAxis(x) {
      svg.selectAll('.axis').remove();
      const axis = d3.axisTop(x).ticks(8).tickFormat(d3.format(',d'));
      svg.append('g').attr('class','axis').attr('transform', `translate(0,30)`).call(axis)
        .selectAll('text').style('fill', 'var(--fg)');
    }

    function drawSequenceTrack(g, sequence, x) {
      g.selectAll('*').remove();
      g.append('text').attr('x', 4).attr('y', 12).attr('fill', 'var(--muted)').text('Base sequence');
      const span = state.end - state.start;
      if (!sequence || span > 2000) {
        g.append('text').attr('x', 4).attr('y', 26).attr('fill', 'var(--danger)').text('Sequence hidden at this zoom. Zoom further for bases.');
        return;
      }
      const bases = sequence.split('');
      const y = 30;
      const fontSize = Math.min(16, Math.max(10, 100 / bases.length));
      g.selectAll('text.base').data(bases).enter().append('text')
        .attr('class','base')
        .attr('x', (_, i) => x(state.start + i))
        .attr('y', y)
        .attr('text-anchor','middle')
        .attr('fill','var(--fg)')
        .style('font-size', fontSize + 'px')
        .text(d => d.toUpperCase());
    }

    function drawVariantTrack(g, data, x, color) {
      g.selectAll('*').remove();
      g.append('text').attr('x', 4).attr('y', 12).attr('fill', 'var(--muted)').text('Variants');
      if (!data?.length) return;
      const yBase = 40;
      g.selectAll('line.variant').data(data).enter().append('line')
        .attr('class','variant')
        .attr('x1', d => x(d.pos))
        .attr('x2', d => x(d.pos))
        .attr('y1', yBase)
        .attr('y2', d => yBase - 20 * (d.value || 0.8))
        .attr('stroke', color).attr('stroke-width', 2);
      g.selectAll('circle.variant').data(data).enter().append('circle')
        .attr('cx', d => x(d.pos)).attr('cy', d => yBase - 20 * (d.value || 0.8))
        .attr('r', 5).attr('fill', color)
        .append('title').text(d => `${d.id || 'variant'} @ ${d.pos}`);
    }

    function drawCoverageTrack(g, data, x, color, height) {
      g.selectAll('*').remove();
      g.append('text').attr('x', 4).attr('y', 12).attr('fill', 'var(--muted)').text('Coverage');
      if (!data?.length) return;
      const maxV = d3.max(data, d => d.value) || 1;
      const y = d3.scaleLinear().domain([0, maxV]).range([height-10, 20]);
      const area = d3.area().x(d => x((d.start + d.end)/2)).y0(y(0)).y1(d => y(d.value)).curve(d3.curveMonotoneX);
      g.append('path').datum(data).attr('fill', color + '33').attr('stroke', color).attr('stroke-width', 1.2).attr('d', area);
    }

    function drawGenesTrack(g, genes, x) {
      g.selectAll('*').remove();
      g.append('text').attr('x', 4).attr('y', 12).attr('fill', 'var(--muted)').text('Genes');
      if (!genes?.length) return;
      const yBase = 40;
      const bandHeight = 16;
      const visible = genes.filter(gene => gene.end >= state.start && gene.start <= state.end);
      const geneGroups = g.selectAll('g.gene').data(visible, d => d.name);
      const enter = geneGroups.enter().append('g').attr('class','gene');
      enter.append('line').attr('class','intron');
      enter.append('rect').attr('class','gene-box');
      enter.append('text').attr('class','gene-label');
      const merged = enter.merge(geneGroups);
      merged.select('line.intron')
        .attr('x1', d => x(d.start)).attr('x2', d => x(d.end))
        .attr('y1', yBase + bandHeight/2).attr('y2', yBase + bandHeight/2)
        .attr('stroke', '#64748b').attr('stroke-dasharray','2,2');
      merged.select('rect.gene-box')
        .attr('x', d => x(d.start))
        .attr('y', yBase)
        .attr('width', d => Math.max(2, x(d.end) - x(d.start)))
        .attr('height', bandHeight)
        .attr('rx', 3)
        .attr('fill', '#60a5fa88')
        .attr('stroke', '#60a5fa')
        .append('title').text(d => `${d.name} (${d.strand})`);
      merged.select('text.gene-label')
        .attr('x', d => x(d.start) + 4)
        .attr('y', yBase + bandHeight + 12)
        .attr('fill', 'var(--fg)')
        .style('font-size','11px')
        .text(d => d.name);
      merged.selectAll('path.exon').remove();
      merged.each(function(gene) {
        const exons = gene.exons || [];
        const holder = d3.select(this);
        holder.selectAll('rect.exon').data(exons).enter().append('rect')
          .attr('class','exon')
          .attr('x', e => x(e.start)).attr('width', e => Math.max(2, x(e.end) - x(e.start)))
          .attr('y', yBase - 4).attr('height', bandHeight + 8)
          .attr('rx', 2)
          .attr('fill', '#38bdf833');
      });
      geneGroups.exit().remove();
    }

    function drawCustomTrack(g, track, x) {
      g.selectAll('*').remove();
      const label = track.type === 'coverage' ? 'Coverage' : 'Custom features';
      g.append('text').attr('x', 4).attr('y', 12).attr('fill', 'var(--muted)').text(label);
      if (!track.data?.length) return;
      if (track.type === 'coverage') {
        drawCoverageTrack(g, track.data, x, track.color || '#f97316', track.height || 50);
        return;
      }
      const bandHeight = 16;
      const yBase = 34;
      const features = track.data;
      g.selectAll('rect.feature').data(features).enter().append('rect')
        .attr('class','feature')
        .attr('x', d => x(d.start))
        .attr('y', yBase)
        .attr('width', d => Math.max(2, x(d.end) - x(d.start)))
        .attr('height', bandHeight)
        .attr('rx', 3)
        .attr('fill', (track.color || '#f97316') + '66')
        .attr('stroke', track.color || '#f97316')
        .append('title').text(d => `${d.name || 'feature'}: ${d.start}-${d.end}`);
    }

    async function renderTracks(sequence) {
      const x = scaleX();
      const visibleTracks = state.tracks.filter(t => t.visible !== false);
      const baseY = 60;
      const spacing = Number(state.spacing) || 18;
      const totalHeight = baseY + visibleTracks.reduce((sum, t) => sum + (t.height || 60) + spacing, 0);
      svg.attr('height', Math.max(320, totalHeight));
      drawAxis(x);
      const trackGroups = svg.selectAll('g.track').data(visibleTracks, d => d.id);
      const enter = trackGroups.enter().append('g').attr('class','track');
      const merged = enter.merge(trackGroups);
      merged.attr('transform', (d, i) => `translate(0, ${baseY + i * ((d.height || 60) + spacing)})`).attr('opacity', d => d.opacity ?? 1);
      for (const track of visibleTracks) {
        const g = merged.filter(d => d.id === track.id);
        if (track.type === 'sequence') {
          drawSequenceTrack(g, sequence, x);
        } else if (track.type === 'variants') {
          drawVariantTrack(g, track.data, x, track.color || '#f43f5e');
        } else if (track.type === 'genes') {
          drawGenesTrack(g, track.data, x);
        } else if (track.type === 'coverage') {
          drawCoverageTrack(g, track.data, x, track.color || '#22c55e', track.height || 60);
        } else if (track.type === 'custom') {
          drawCustomTrack(g, track, x);
        }
      }
      trackGroups.exit().remove();
    }

    async function renderAll() {
      clampRegion();
      updateStatusBar();
      renderLegend();
      renderTrackList();
      document.documentElement.dataset.theme = state.theme;
      document.body.dataset.theme = state.theme;
      spacingSlider.value = state.spacing;
      spacingValue.textContent = state.spacing;
      document.getElementById('assembly').value = state.assembly;
      document.getElementById('search').value = `${state.chrom}:${state.start}-${state.end}`;
      document.getElementById('themeToggle').checked = state.theme === 'light';
      const needsSequence = state.tracks.some(t => t.visible !== false && t.type === 'sequence');
      let seq = '';
      if (needsSequence) {
        const res = await fetchSequence();
        seq = res.sequence;
        updateStatus(`Sequence: ${res.source}`, !!res.sequence);
      } else {
        updateStatus('Region loaded');
      }
      renderTracks(seq);
      saveState();
    }

    function parseCustomText(text, type) {
      const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const records = [];
      for (const line of lines) {
        const [chrom, start, end, name, extra] = line.split(/\t+/);
        const s = Number(start), e = Number(end);
        if (!chrom || !Number.isFinite(s) || !Number.isFinite(e) || e <= s) continue;
        if (chrom !== state.chrom) continue;
        if (type === 'coverage') {
          const value = Number(extra) || 10;
          records.push({ start: s, end: e, value });
        } else if (type === 'variants') {
          records.push({ pos: s, id: name || 'variant', value: Number(extra) || 0.5 });
        } else {
          records.push({ start: s, end: e, name: name || 'feature', strand: extra || '+' });
        }
      }
      if (!records.length) throw new Error('No valid rows parsed for current chromosome.');
      return records;
    }

    function resetState() {
      state = defaultState();
      saveState();
      renderAll();
    }

    function handleFileUpload(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Unable to read file'));
        reader.onload = () => resolve(reader.result.toString());
        reader.readAsText(file);
      });
    }

    async function addCustomTrack() {
      const name = document.getElementById('customName').value.trim() || 'Custom track';
      const color = document.getElementById('customColor').value || '#f97316';
      const type = document.getElementById('customType').value;
      const text = document.getElementById('customText').value.trim();
      const file = document.getElementById('fileInput').files[0];
      const errorBox = document.getElementById('customError');
      errorBox.textContent = '';
      try {
        let content = text;
        if (file) content = await handleFileUpload(file);
        if (!content) throw new Error('Provide a file or paste text');
        const data = parseCustomText(content, type);
        const track = {
          id: 'custom-' + Math.random().toString(36).slice(2,7),
          name,
          type,
          color,
          height: type === 'coverage' ? 60 : 50,
          opacity: 1,
          visible: true,
          source: 'user-upload',
          data
        };
        state.tracks.push(track);
        saveState();
        renderAll();
        document.getElementById('customText').value = '';
        document.getElementById('fileInput').value = '';
      } catch (err) {
        errorBox.textContent = err.message;
      }
    }

    function setRegionFromInput(str) {
      const parsed = parseRegionInput(str);
      if (!parsed) {
        updateStatus('Invalid input. Use gene alias or chr:start-end.', false);
        return;
      }
      state.chrom = parsed.chrom || state.chrom;
      state.start = parsed.start || state.start;
      state.end = parsed.end || state.end;
      if (parsed.assembly) state.assembly = parsed.assembly;
      renderAll();
    }

    function openUCSC() {
      const url = `https://genome.ucsc.edu/cgi-bin/hgTracks?db=${encodeURIComponent(state.assembly)}&position=${encodeURIComponent(state.chrom)}:${state.start}-${state.end}`;
      window.open(url, '_blank', 'noopener');
    }

    function attachInteractions() {
      document.getElementById('go').addEventListener('click', () => setRegionFromInput(document.getElementById('search').value));
      document.getElementById('openUCSC').addEventListener('click', openUCSC);
      document.getElementById('assembly').addEventListener('change', (e) => {
        state.assembly = e.target.value;
        clampRegion();
        renderAll();
      });
      document.getElementById('zoomIn').addEventListener('click', () => zoom(0.5));
      document.getElementById('zoomOut').addEventListener('click', () => zoom(2));
      document.getElementById('addTrack').addEventListener('click', addCustomTrack);
      document.getElementById('reset').addEventListener('click', resetState);
      document.getElementById('themeToggle').addEventListener('change', (e) => {
        state.theme = e.target.checked ? 'light' : 'dark';
        document.body.dataset.theme = state.theme;
        saveState();
        renderAll();
      });
      spacingSlider.addEventListener('input', (e) => {
        state.spacing = Number(e.target.value);
        spacingValue.textContent = state.spacing;
        saveState();
        renderAll();
      });
      document.getElementById('search').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('go').click(); } });
      svg.on('wheel', (event) => {
        event.preventDefault();
        const delta = Math.sign(event.deltaY);
        const factor = delta > 0 ? 1.2 : 0.8;
        zoom(factor, event.offsetX);
      });
      const drag = d3.drag().on('drag', (event) => {
        const span = state.end - state.start;
        const bpPerPx = span / innerWidthForSvg();
        const delta = event.dx * bpPerPx;
        state.start = Math.max(1, state.start - delta);
        state.end = Math.max(state.start + 10, state.end - delta);
        clampRegion();
        renderAll();
      });
      svg.call(drag);
    }

    function zoom(factor, anchorPx = innerWidthForSvg()/2) {
      const x = scaleX();
      const anchorBp = x.invert(anchorPx + 40);
      const newSpan = Math.max(50, Math.min(5e7, (state.end - state.start) * factor));
      let newStart = anchorBp - (anchorBp - state.start) * factor;
      let newEnd = newStart + newSpan;
      const chromLen = assemblies[state.assembly]?.chromosomes?.[state.chrom]?.length || 1e9;
      if (newStart < 1) { newEnd += 1 - newStart; newStart = 1; }
      if (newEnd > chromLen) { newStart -= (newEnd - chromLen); newEnd = chromLen; }
      state.start = Math.max(1, Math.floor(newStart));
      state.end = Math.floor(newEnd);
      renderAll();
    }

    window.addEventListener('resize', debounce(() => renderAll(), 200));

    attachInteractions();
    renderAll();
  })();
  </script>
</body>
</html>
